<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio Estad√≠stico Pro</title>
    
    <!-- Fuentes y Estilos -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:ital,wght@0,400;0,700;1,400&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Librer√≠as JS -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.4/jstat.min.js"></script>
    
    <!-- MathJax (LaTeX) -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        /* --- ESTILOS (Fusi√≥n de tu styles.css y mejoras) --- */
        :root { 
            --primary: #1a365d; /* Azul Oxford */
            --secondary: #2b6cb0; /* Azul Royal */
            --accent: #ed8936; /* Naranja */
            --bg: #f8fafc; 
            --text: #2d3748;
            --border: #e2e8f0;
        }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 120px; line-height: 1.6; }
        .container { max-width: 950px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid var(--border); padding-bottom: 20px; }
        header h1 { color: var(--primary); font-size: 2.2rem; margin: 0; font-weight: 800; letter-spacing: -1px; }
        header p { color: #718096; margin-top: 5px; font-style: italic; }

        /* Barra Superior */
        .top-bar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px; }
        .tool-btn { background: white; border: 1px solid #cbd5e0; color: #4a5568; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 600; transition: 0.2s; }
        .tool-btn:hover { border-color: var(--primary); color: var(--primary); background: #ebf8ff; }
        .tool-btn.danger:hover { border-color: #e53e3e; color: #e53e3e; background: #fff5f5; }

        /* Tabs */
        .tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; background: white; padding: 8px; border-radius: 50px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); width: fit-content; margin: 0 auto 30px auto; }
        .tab-btn { background: transparent; border: none; padding: 10px 24px; border-radius: 20px; font-weight: 600; color: #718096; cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(26,54,93,0.25); }
        
        /* Panel Principal */
        .main-card { background: white; border-radius: 12px; padding: 30px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .tab-panel { display: none; animation: fadeIn 0.3s; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Formularios */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .input-group label { display: block; font-weight: 700; font-size: 0.75rem; color: #4a5568; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.5px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; color: var(--primary); transition: 0.2s; box-sizing: border-box; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15); }

        /* Botones */
        .btn-group { display: flex; gap: 15px; margin-top: 20px; }
        .btn { flex: 1; border: none; padding: 14px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 0.95rem; text-transform: uppercase; }
        .btn-calc { background: var(--primary); color: white; }
        .btn-calc:hover { background: #152c4e; transform: translateY(-1px); }
        .btn-table { background: white; border: 2px solid #e2e8f0; color: #4a5568; }
        .btn-table:hover { border-color: var(--secondary); color: var(--secondary); background: #ebf8ff; }

        /* --- ESTILOS DE RESULTADOS (Del archivo main.js/binomial.js) --- */
        .history-section { margin-top: 40px; border-top: 2px solid var(--border); padding-top: 20px; }
        .history-item { background: white; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 25px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.04); page-break-inside: avoid; }
        
        .history-header { background: #f8fafc; padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .history-header h4 { margin: 0; color: var(--primary); font-weight: 800; font-size: 1rem; }
        
        .history-body { padding: 20px; display: grid; grid-template-columns: 60% 40%; gap: 20px; }
        
        /* Cajas de Detalle Matem√°tico */
        .detail-box-formula { background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 10px; font-family: 'Lora', serif; font-size: 0.95rem; }
        .detail-box-sum { background: #f1f8ff; padding: 15px; border-radius: 8px; border: 1px solid #d1e9ff; margin-bottom: 10px; font-family: 'Lora', serif; font-size: 0.95rem; }
        .detail-box-steps { background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-top: 10px; font-size: 0.9em; color: #666; max-height: 200px; overflow-y: auto; }
        .detail-box-complement { background: #fdf6e3; padding: 15px; border-left: 5px solid #b58900; border-radius: 8px; margin-bottom: 10px; font-family: 'Lora', serif; }

        .mini-chart { width: 100%; height: 250px; border: 1px solid #e2e8f0; border-radius: 8px; background: white; }

        /* Tablas */
        .table-container { overflow-x: auto; margin-top: 10px; border: 1px solid #e2e8f0; border-radius: 8px; max-height: 300px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .data-table th { background: #2c3e50; color: white; padding: 10px; text-align: center; position: sticky; top: 0; }
        .data-table td { border: 1px solid #ddd; padding: 8px; text-align: center; font-family: 'Fira Code', monospace; }
        .data-table tr:nth-child(even) { background: #f9f9f9; }

        /* Modal Caf√© */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa; }
        
        .cafe-float { position: fixed; bottom: 30px; right: 30px; background: #FFDD00; color: #000; padding: 12px 25px; border-radius: 50px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: none; z-index: 100; transition: transform 0.2s; display: flex; align-items: center; gap: 8px; text-decoration: none; animation: pulse 3s infinite; }
        .cafe-float:hover { transform: scale(1.05); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 221, 0, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 221, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 221, 0, 0); } }

        /* Print Fixes */
        @media print {
            .no-print, .tabs, .main-card, .cafe-float { display: none !important; }
            .history-section { border: none; margin: 0; }
            .history-item { break-inside: avoid; border: 1px solid #ccc; box-shadow: none; margin-bottom: 20px; }
            .history-body { display: block; grid-template-columns: 1fr; }
            .mini-chart { width: 100%; height: 200px; margin-top: 15px; border: 1px solid #ccc; page-break-inside: avoid; }
            .detail-box-steps, .table-container { max-height: none; overflow: visible; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
        
        @media (max-width: 768px) {
            .history-body { grid-template-columns: 1fr; }
            .mini-chart { order: -1; margin-bottom: 20px; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <!-- Barra Superior -->
    <div class="top-bar no-print">
        <button class="tool-btn" onclick="window.print()">
            <i class="fa-solid fa-print"></i> Imprimir Reporte
        </button>
        <button class="tool-btn danger" onclick="App.clearHistory()">
            <i class="fa-solid fa-trash"></i> Limpiar Historial
        </button>
    </div>

    <header class="no-print">
        <h1>üìä Laboratorio Estad√≠stico</h1>
        <p>C√°lculo de Probabilidades Paso a Paso</p>
    </header>

    <!-- Navegaci√≥n -->
    <nav class="tabs no-print">
        <button class="tab-btn active" onclick="App.switchTab('normal')">Normal</button>
        <button class="tab-btn" onclick="App.switchTab('binomial')">Binomial</button>
        <button class="tab-btn" onclick="App.switchTab('poisson')">Poisson</button>
        <button class="tab-btn" onclick="App.switchTab('geometrica')">Geom√©trica</button>
    </nav>

    <main class="main-card no-print">
        <!-- NORMAL -->
        <div id="tab-normal" class="tab-panel active">
            <div class="form-grid">
                <div class="input-group"><label>Media ($\mu$)</label><input type="number" id="n_m" value="0" step="any"></div>
                <div class="input-group"><label>Desviaci√≥n ($\sigma$)</label><input type="number" id="n_s" value="1" step="any"></div>
                <div class="input-group"><label>C√°lculo</label>
                    <select id="n_t" onchange="App.uiNormal()">
                        <option value="menor">√Årea Izquierda $P(X \le a)$</option>
                        <option value="mayor">√Årea Derecha $P(X > a)$</option>
                        <option value="entre">Intervalo $P(a \le X \le b)$</option>
                        <option value="inv">Inversa (Dado P, hallar X)</option>
                    </select>
                </div>
                <div class="input-group"><label id="l_a">Valor ($a$)</label><input type="number" id="n_a" value="1.5" step="any"></div>
                <div class="input-group" id="g_b" style="display:none;"><label>Valor ($b$)</label><input type="number" id="n_b" value="2" step="any"></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-calc" onclick="App.calcNormal()">Calcular Probabilidad</button>
            </div>
        </div>

        <!-- BINOMIAL -->
        <div id="tab-binomial" class="tab-panel">
            <div class="form-grid">
                <div class="input-group"><label>Ensayos ($n$)</label><input type="number" id="b_n" value="10"></div>
                <div class="input-group"><label>Probabilidad ($p$)</label><input type="number" id="b_p" step="0.01" value="0.5"></div>
                <div class="input-group"><label>Operador</label>
                    <select id="b_t">
                        <option value="igual">$P(X = k)$ Exacto</option>
                        <option value="menor">$P(X < k)$ Menor estricto</option>
                        <option value="menorigual" selected>$P(X \le k)$ Menor o igual</option>
                        <option value="mayor">$P(X > k)$ Mayor estricto</option>
                        <option value="mayorigual">$P(X \ge k)$ Mayor o igual</option>
                    </select>
                </div>
                <div class="input-group"><label>Valor ($k$)</label><input type="number" id="b_k" value="5"></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-calc" onclick="App.calcBinomial()">Calcular</button>
                <button class="btn btn-table" onclick="App.genTable('binomial')">Generar Tabla Completa</button>
            </div>
        </div>

        <!-- POISSON -->
        <div id="tab-poisson" class="tab-panel">
            <div class="form-grid">
                <div class="input-group"><label>Lambda ($\lambda$)</label><input type="number" id="p_l" value="4" step="any"></div>
                <div class="input-group"><label>Operador</label>
                    <select id="p_t">
                        <option value="igual">$P(X = k)$ Exacto</option>
                        <option value="menor">$P(X < k)$ Menor estricto</option>
                        <option value="menorigual" selected>$P(X \le k)$ Menor o igual</option>
                        <option value="mayor">$P(X > k)$ Mayor estricto</option>
                        <option value="mayorigual">$P(X \ge k)$ Mayor o igual</option>
                    </select>
                </div>
                <div class="input-group"><label>Valor ($k$)</label><input type="number" id="p_k" value="2"></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-calc" onclick="App.calcPoisson()">Calcular</button>
                <button class="btn btn-table" onclick="App.genTable('poisson')">Generar Tabla Completa</button>
            </div>
        </div>

        <!-- GEOM√âTRICA -->
        <div id="tab-geometrica" class="tab-panel">
            <div class="form-grid">
                <div class="input-group"><label>Probabilidad ($p$)</label><input type="number" id="g_p" value="0.3" step="any"></div>
                <div class="input-group"><label>Operador</label>
                    <select id="g_t">
                        <option value="igual">$P(X = k)$ Exacto</option>
                        <option value="menor">$P(X < k)$ Menor estricto</option>
                        <option value="menorigual" selected>$P(X \le k)$ Menor o igual</option>
                        <option value="mayor">$P(X > k)$ Mayor estricto</option>
                        <option value="mayorigual">$P(X \ge k)$ Mayor o igual</option>
                    </select>
                </div>
                <div class="input-group"><label>Intento ($k$)</label><input type="number" id="g_k" value="3"></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-calc" onclick="App.calcGeometrica()">Calcular</button>
                <button class="btn btn-table" onclick="App.genTable('geometrica')">Generar Tabla Completa</button>
            </div>
        </div>
    </main>

    <!-- Historial -->
    <div class="history-section">
        <h3 style="color:var(--primary); margin-bottom: 20px;"><i class="fa-solid fa-clock-rotate-left"></i> Historial de Reportes</h3>
        <div id="history-container">
            <div style="text-align: center; color: #a0aec0; padding: 40px; border: 2px dashed #e2e8f0; border-radius: 12px;" class="no-print">
                <i class="fa-solid fa-calculator" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>Los c√°lculos realizados aparecer√°n aqu√≠.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Caf√© -->
<div id="modalCafe" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" onclick="document.getElementById('modalCafe').style.display='none'">&times;</span>
        <h2 style="color:var(--primary); margin-top:0;">¬øTe fue √∫til? üöÄ</h2>
        <p style="color:#666;">Ayuda a mantener esta herramienta gratuita.</p>
        <div style="margin-top:20px; display:flex; flex-direction:column; gap:15px;">
            <a href="https://buymeacoffee.com/juanjose66f" target="_blank" style="background:#000; color:white; text-decoration:none; padding:12px; border-radius:8px; font-weight:bold;">
                üåç Donar con Tarjeta (Stripe)
            </a>
            <div style="border-top:1px solid #eee; padding-top:15px;">
                <p style="margin:0 0 5px 0; font-weight:bold; color:var(--secondary); font-size:0.85rem; text-transform: uppercase;">Colombia (Nequi / Daviplata)</p>
                <div style="background:#f0f4f8; padding:10px; border-radius:8px; font-family:'Fira Code', monospace; font-size:1.2em; font-weight:bold; color:#333;">300 453 5859</div>
            </div>
        </div>
    </div>
</div>

<button class="cafe-float no-print" onclick="document.getElementById('modalCafe').style.display='flex'">
    ‚òï Inv√≠tame un caf√©
</button>

<script>
    // ==========================================
    // LOGICA DE NEGOCIO (Recuperada de tus scripts)
    // ==========================================
    const App = {
        // --- Utils Matem√°ticos ---
        fact: (n) => { if(n<0) return 0; return n<=1?1:n*App.fact(n-1); },
        nCr: (n,r) => App.fact(n)/(App.fact(r)*App.fact(n-r)),
        
        formatSum: (arr, prop) => {
            if (arr.length <= 4) return arr.map(i => i[prop]).join(" + ");
            return `${arr[0][prop]} + ${arr[1][prop]} + \\dots + ${arr[arr.length-1][prop]}`;
        },

        // --- Generaci√≥n de Pasos Individuales (Como en binomial.js) ---
        getBinomialStep: (n, k, p) => {
            const q = 1 - p;
            const prob = App.nCr(n, k) * Math.pow(p, k) * Math.pow(q, n - k);
            return { 
                valor: prob, 
                formula: `P(X=${k})`, 
                html: `<p>\\[ P(X=${k}) = \\binom{${n}}{${k}} (${p})^{${k}} (${q.toFixed(4)})^{${n-k}} = ${prob.toFixed(6)} \\]</p>` 
            };
        },
        getPoissonStep: (l, k) => {
            const prob = (Math.pow(Math.E, -l) * Math.pow(l, k)) / App.fact(k);
            return {
                valor: prob, 
                formula: `P(X=${k})`, 
                html: `<p>\\[ P(X=${k}) = \\frac{e^{-${l}} \\cdot ${l}^{${k}}}{${k}!} = ${prob.toFixed(6)} \\]</p>`
            };
        },
        getGeoStep: (p, k) => {
            const q = 1 - p;
            const prob = Math.pow(q, k - 1) * p;
            return {
                valor: prob,
                formula: `P(X=${k})`,
                html: `<p>\\[ P(X=${k}) = (${q.toFixed(4)})^{${k}-1} \\cdot ${p} = ${prob.toFixed(6)} \\]</p>`
            };
        },

        // --- UI ---
        switchTab: (id) => {
            document.querySelectorAll('.tab-panel').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            event.currentTarget.classList.add('active');
        },
        uiNormal: () => {
            const t = document.getElementById('n_t').value;
            const isInv = t === 'inv';
            document.getElementById('g_b').style.display = t === 'entre' ? 'block' : 'none';
            document.getElementById('l_a').innerText = isInv ? 'Probabilidad (p)' : 'Valor (a)';
        },
        clearHistory: () => {
            if(confirm("¬øBorrar historial?")) document.getElementById('history-container').innerHTML = '';
        },

        // --- C√ÅLCULO NORMAL (Con inversa y gr√°fica sombreada) ---
        calcNormal: () => {
            const m = parseFloat(document.getElementById('n_m').value);
            const s = parseFloat(document.getElementById('n_s').value);
            const t = document.getElementById('n_t').value;
            const a = parseFloat(document.getElementById('n_a').value);
            const b = parseFloat(document.getElementById('n_b').value);

            let res = 0, html = "", plotTitle = "";
            let xPoints=[], yPoints=[], xFill=[], yFill=[];
            const range = 4*s; 
            
            // Generar curva base
            for(let i=m-range; i<=m+range; i+=s/50) {
                xPoints.push(i); yPoints.push(jStat.normal.pdf(i,m,s));
            }

            if(t === 'inv') {
                res = jStat.normal.inv(a, m, s);
                html = `<div class="detail-box-formula"><strong>Inversa:</strong> Dado $p=${a}$, el valor $x$ es: \\[ x = \\Phi^{-1}(${a}) = \\mathbf{${res.toFixed(4)}} \\]</div>`;
                plotTitle = `Normal Inversa (p=${a})`;
                // Sombreado hasta el resultado
                for(let i=m-range; i<=res; i+=s/50) { xFill.push(i); yFill.push(jStat.normal.pdf(i,m,s)); }
            } else {
                let z1 = (a-m)/s;
                if(t === 'menor') {
                    res = jStat.normal.cdf(a,m,s);
                    html = `<div class="detail-box-formula"><p>Estandarizaci√≥n: $Z = \\frac{${a}-${m}}{${s}} = ${z1.toFixed(2)}$</p><p>Tabla: $P(Z \\le ${z1.toFixed(2)}) = \\mathbf{${res.toFixed(5)}}$</p></div>`;
                    for(let i=m-range; i<=a; i+=s/50) { xFill.push(i); yFill.push(jStat.normal.pdf(i,m,s)); }
                } else if(t === 'mayor') {
                    res = 1 - jStat.normal.cdf(a,m,s);
                    html = `<div class="detail-box-formula"><p>Cola Derecha: $1 - P(Z \\le ${z1.toFixed(2)}) = \\mathbf{${res.toFixed(5)}}$</p></div>`;
                    for(let i=a; i<=m+range; i+=s/50) { xFill.push(i); yFill.push(jStat.normal.pdf(i,m,s)); }
                } else {
                    let z2 = (b-m)/s;
                    res = jStat.normal.cdf(b,m,s) - jStat.normal.cdf(a,m,s);
                    html = `<div class="detail-box-formula"><p>Intervalo: $P(${z1.toFixed(2)} \\le Z \\le ${z2.toFixed(2)}) = \\mathbf{${res.toFixed(5)}}$</p></div>`;
                    for(let i=a; i<=b; i+=s/50) { xFill.push(i); yFill.push(jStat.normal.pdf(i,m,s)); }
                }
            }
            if(xFill.length) { xFill.unshift(xFill[0]); yFill.unshift(0); xFill.push(xFill[xFill.length-1]); yFill.push(0); }

            const plotData = { data: [{x:xPoints, y:yPoints, type:'scatter', mode:'lines', line:{color:'#2b6cb0'}, name:'Curva'}, {x:xFill, y:yFill, type:'scatter', fill:'tozeroy', mode:'none', fillcolor:'rgba(43, 108, 176, 0.5)', name:'Probabilidad'}], layout: { title: 'Distribuci√≥n Normal', showlegend:false, margin:{t:30,l:30,r:10,b:30}, height:250 } };
            App.addToHistory("Normal", html, res, plotData);
        },

        // --- C√ÅLCULO BINOMIAL (L√≥gica exacta de 5 operadores de binomial.js) ---
        calcBinomial: () => {
            const n=parseInt(document.getElementById('b_n').value), p=parseFloat(document.getElementById('b_p').value), k=parseInt(document.getElementById('b_k').value), t=document.getElementById('b_t').value;
            let start=0, end=0, opSym="";

            // Ajuste de rangos seg√∫n operador (L√≥gica de tus archivos)
            if(t==='igual') { start=k; end=k; opSym='='; }
            else if(t==='menor') { start=0; end=k-1; opSym='<'; }
            else if(t==='menorigual') { start=0; end=k; opSym='\\le'; }
            else if(t==='mayor') { start=k+1; end=n; opSym='>'; }
            else if(t==='mayorigual') { start=k; end=n; opSym='\\ge'; }
            
            if(start<0) start=0; if(end>n) end=n;
            
            let res=0, steps=[];
            for(let i=start; i<=end; i++) {
                const item = App.getBinomialStep(n, i, p);
                steps.push(item); res += item.valor;
            }
            if(start>end) res=0;

            let html = "";
            if(t==='igual') {
                html = `<div class="detail-box-formula"><p><strong>F√≥rmula:</strong> \\[ P(X=k) = \\binom{n}{k} p^k q^{n-k} \\]</p>${steps.length?steps[0].html:''}</div>`;
            } else {
                html = `<div class="detail-box-sum"><p><strong>Sumatoria (${t}):</strong> \\[ P(X ${opSym} ${k}) = ${App.formatSum(steps, 'formula')} \\] \\[ = \\mathbf{${res.toFixed(6)}} \\]</p></div>
                        <div class="detail-box-steps">${steps.map(s=>s.html).join('')}</div>`;
            }

            // Gr√°fica
            const x=[], y=[], c=[];
            for(let i=0; i<=n; i++) {
                x.push(i); y.push(App.getBinomialStep(n,i,p).valor);
                c.push((i>=start && i<=end) ? '#2b6cb0' : '#e2e8f0');
            }
            const plotData = { data: [{x,y,type:'bar',marker:{color:c}}], layout: { title: `Binomial n=${n}, p=${p}`, margin:{t:30,l:30,r:10,b:30}, height:250 } };
            App.addToHistory(`Binomial (X ${opSym} ${k})`, html, res, plotData);
        },

        // --- C√ÅLCULO POISSON (L√≥gica exacta de poisson.js) ---
        calcPoisson: () => {
            const l=parseFloat(document.getElementById('p_l').value), k=parseInt(document.getElementById('p_k').value), t=document.getElementById('p_t').value;
            let start=0, end=0, opSym="";

            if(t==='igual') { start=k; end=k; opSym='='; }
            else if(t==='menor') { start=0; end=k-1; opSym='<'; }
            else if(t==='menorigual') { start=0; end=k; opSym='\\le'; }
            else if(t==='mayor') { start=k+1; end=k+20; opSym='>'; }
            else if(t==='mayorigual') { start=k; end=k+20; opSym='\\ge'; }
            if(start<0) start=0;

            let res=0, steps=[];
            // L√≥gica de complemento para cola derecha infinita
            if(t.includes('mayor')) {
                let limitInf = (t==='mayor') ? k : k-1;
                let sumC = 0;
                for(let i=0; i<=limitInf; i++) sumC += App.getPoissonStep(l,i).valor;
                res = 1 - sumC;
                for(let i=start; i<=start+4; i++) steps.push(App.getPoissonStep(l,i)); // Muestra solo primeros
            } else {
                for(let i=start; i<=end; i++) {
                    const item = App.getPoissonStep(l,i);
                    steps.push(item); res += item.valor;
                }
            }
            if(start>end && !t.includes('mayor')) res=0;

            let html = "";
            if(t==='igual') {
                html = `<div class="detail-box-formula"><p><strong>F√≥rmula:</strong> \\[ P(X=k) = \\frac{e^{-\\lambda}\\lambda^k}{k!} \\]</p>${steps.length?steps[0].html:''}</div>`;
            } else {
                const extra = t.includes('mayor') ? '+ \\dots' : '';
                html = `<div class="detail-box-sum"><p><strong>Sumatoria:</strong> \\[ P(X ${opSym} ${k}) = ${App.formatSum(steps, 'formula')}${extra} \\] \\[ \\approx \\mathbf{${res.toFixed(6)}} \\]</p></div>`;
                if(!t.includes('mayor')) html += `<div class="detail-box-steps">${steps.map(s=>s.html).join('')}</div>`;
            }

            const x=[], y=[], c=[];
            const limitV = Math.ceil(l+4*Math.sqrt(l)) + (t.includes('mayor')?10:0);
            for(let i=0; i<=limitV; i++) {
                x.push(i); y.push(App.getPoissonStep(l,i).valor);
                let hl = false;
                if(t==='igual'&&i===k) hl=true;
                else if(t==='menor'&&i<k) hl=true;
                else if(t==='menorigual'&&i<=k) hl=true;
                else if(t==='mayor'&&i>k) hl=true;
                else if(t==='mayorigual'&&i>=k) hl=true;
                c.push(hl ? '#ed8936' : '#e2e8f0');
            }
            const plotData = { data: [{x,y,type:'bar',marker:{color:c}}], layout: { title: `Poisson Œª=${l}`, margin:{t:30,l:30,r:10,b:30}, height:250 } };
            App.addToHistory(`Poisson (X ${opSym} ${k})`, html, res, plotData);
        },

        // --- C√ÅLCULO GEOM√âTRICA (L√≥gica exacta de geometrica.js) ---
        calcGeometrica: () => {
            const p=parseFloat(document.getElementById('g_p').value), k=parseInt(document.getElementById('g_k').value), t=document.getElementById('g_t').value;
            const q = 1-p;
            let res=0, html="", opSym="";

            if(t==='igual') {
                opSym='='; res = Math.pow(q, k-1)*p;
                html=`<div class="detail-box-formula"><p><strong>Exacta:</strong> \\[ P(X=k) = q^{k-1}p \\] \\[ = (${q.toFixed(2)})^{${k-1}}(${p}) = \\mathbf{${res.toFixed(6)}} \\]</p></div>`;
            } else if(t==='menor' || t==='menorigual') {
                opSym = t==='menor'?'<':'\\le';
                let limit = t==='menor'?k-1:k;
                if(limit<1) res=0; else res = 1 - Math.pow(q, limit);
                html=`<div class="detail-box-sum"><p><strong>Acumulada:</strong> \\[ P(X \\le r) = 1 - q^r \\] \\[ P(X ${opSym} ${k}) = 1 - (${q.toFixed(2)})^{${limit}} = \\mathbf{${res.toFixed(6)}} \\]</p></div>`;
            } else {
                opSym = t==='mayor'?'>':'\\ge';
                let exp = t==='mayor'?k:k-1;
                res = Math.pow(q, exp);
                html=`<div class="detail-box-complement"><p><strong>Cola Derecha (Supervivencia):</strong> \\[ P(X > r) = q^r \\] \\[ P(X ${opSym} ${k}) = (${q.toFixed(2)})^{${exp}} = \\mathbf{${res.toFixed(6)}} \\]</p></div>`;
            }

            const x=[], y=[], c=[];
            for(let i=1; i<=15; i++) {
                x.push(i); y.push(Math.pow(q,i-1)*p);
                let hl = false;
                if(t==='igual'&&i===k) hl=true;
                else if(t==='menor'&&i<k) hl=true;
                else if(t==='menorigual'&&i<=k) hl=true;
                else if(t==='mayor'&&i>k) hl=true;
                else if(t==='mayorigual'&&i>=k) hl=true;
                c.push(hl ? '#2b6cb0' : '#e2e8f0');
            }
            const plotData = { data: [{x,y,type:'bar',marker:{color:c}}], layout: { title: `Geom√©trica p=${p}`, margin:{t:30,l:30,r:10,b:30}, height:250 } };
            App.addToHistory(`Geom√©trica (X ${opSym} ${k})`, html, res, plotData);
        },

        // --- TABLA COMPLETA (Ahora se agrega al Historial, NO Modal) ---
        genTable: (type) => {
            let rows = "", title = "";
            let start=0, end=10, getProb = () => 0;

            if(type==='binomial') {
                const n = parseInt(document.getElementById('b_n').value);
                const p = parseFloat(document.getElementById('b_p').value);
                title = `Tabla Binomial (n=${n})`; end=n;
                getProb = (i) => App.getBinomialStep(n, i, p).valor;
            } else if(type==='poisson') {
                const l = parseFloat(document.getElementById('p_l').value);
                title = `Tabla Poisson (Œª=${l})`; end=Math.ceil(l+5*Math.sqrt(l));
                getProb = (i) => App.getPoissonStep(l, i).valor;
            } else if(type==='geometrica') {
                const p = parseFloat(document.getElementById('g_p').value);
                title = `Tabla Geom√©trica (p=${p})`; start=1; end=25;
                getProb = (i) => App.getGeoStep(p, i).valor;
            }

            let acc = 0;
            for(let i=start; i<=end; i++) {
                let val = getProb(i); acc += val;
                rows += `<tr><td>${i}</td><td>${val.toFixed(6)}</td><td>${acc.toFixed(6)}</td></tr>`;
            }

            const html = `
                <div class="procedimiento-detalle">
                    <p>Tabla de distribuci√≥n de probabilidad y acumulada:</p>
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>k</th><th>P(X=k)</th><th>P(X‚â§k)</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                </div>`;
            
            App.addToHistory(title, html, "Tabla", null);
        },

        // --- GESTI√ìN HISTORIAL ---
        addToHistory: (title, html, resultVal, plotConfig) => {
            const container = document.getElementById('history-container');
            if(container.querySelector('i.fa-calculator')) container.innerHTML = "";

            const div = document.createElement('div');
            div.className = 'history-item';
            const chartId = 'chart-' + Date.now();
            const resDisplay = typeof resultVal === 'number' ? resultVal.toFixed(5) : resultVal;

            div.innerHTML = `
                <div class="history-header">
                    <h4>${title}</h4>
                    <span class="res-badge">Res: ${resDisplay}</span>
                </div>
                <div class="history-body">
                    <div class="procedimiento-detalle">${html}</div>
                    ${plotConfig ? `<div id="${chartId}" class="mini-chart"></div>` : ''}
                </div>`;
            
            container.prepend(div);

            if(plotConfig) {
                const layout = { ...plotConfig.layout, showlegend: false, autosize: true };
                const config = { staticPlot: true, displayModeBar: false, responsive: true };
                Plotly.newPlot(chartId, plotConfig.data, layout, config);
            }
            MathJax.typesetPromise([div]);
        }
    };
</script>

</body>
</html>